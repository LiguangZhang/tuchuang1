<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1621px" preserveAspectRatio="none" style="width:1684px;height:1621px;" version="1.1" viewBox="0 0 1684 1621" width="1684px" zoomAndPan="magnify"><defs><filter height="300%" id="f7o3uaixw28re" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[0d5b5c78d9e58ac8df2aac86b3471f43]
cluster recovery--><polygon fill="#FFFFFF" filter="url(#f7o3uaixw28re)" points="526,235,587,235,594,259.4639,859,259.4639,859,324,526,324,526,235" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="526" x2="594" y1="259.4639" y2="259.4639"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="55" x="530" y="251.6699">recovery</text><!--MD5=[62e981aedead5d296a0ed090cac6c220]
cluster init--><polygon fill="#FFFFFF" filter="url(#f7o3uaixw28re)" points="484,372,511,372,518,396.4639,1126,396.4639,1126,891,484,891,484,372" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="484" x2="518" y1="396.4639" y2="396.4639"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="488" y="388.6699">init</text><!--MD5=[c5fce3abb9d6475e197b946813ca3178]
cluster vold--><polygon fill="#FFFFFF" filter="url(#f7o3uaixw28re)" points="16,924,49,924,56,948.4639,1667,948.4639,1667,1614,16,1614,16,924" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="16" x2="56" y1="948.4639" y2="948.4639"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="20" y="940.6699">vold</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="140" x="542" y="272"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="120" x="552" y="294.5742">format_volume(/data)</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="117" x="725.5" y="272"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="97" x="735.5" y="294.5742">/data/convert_fbe</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="74" x="699" y="409"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="54" x="709" y="431.5742">mount_all</text><polygon fill="#FEFECE" filter="url(#f7o3uaixw28re)" points="728,486,740,498,728,510,716,498,728,486" style="stroke:#A80036;stroke-width:1.5;"/><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="67.4785" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="158" x="646" y="566"/><text fill="#000000" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="687" y="588.5742">install_keyring</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="138" x="656" y="604.4004">ro.crypto.state=encrypted</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="110" x="670" y="620.2266">ro.encrypto.type=file</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="71" x="500.5" y="678"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="51" x="510.5" y="700.5742">installkey</text><polygon fill="#FEFECE" filter="url(#f7o3uaixw28re)" points="548,759,560,771,548,783,536,771,548,759" style="stroke:#A80036;stroke-width:1.5;"/><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="167" x="499.5" y="839"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="147" x="509.5" y="861.5742">vdc vold enablefileencrypto</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="72" x="592" y="678"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="52" x="602" y="700.5742">init_user0</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="51" x="907.5" y="409"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="31" x="917.5" y="431.5742">mkdir</text><polygon fill="#FEFECE" filter="url(#f7o3uaixw28re)" points="948,486,960,498,948,510,936,498,948,486" style="stroke:#A80036;stroke-width:1.5;"/><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="51.6523" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="118" x="897" y="573.5"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="90" x="909.5" y="596.0742">decrypt key from</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="95" x="910" y="611.9004">/data/uncrypt/ref</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="160" x="950" y="678"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="140" x="960" y="700.5742">e4crypt_policy_ensure(dir)</text><path d="M684.5,674 L684.5,718.29 A0,0 0 0 0 684.5,718.29 L929.5,718.29 A0,0 0 0 0 929.5,718.29 L929.5,700 L949.78,696 L929.5,692 L929.5,684 L919.5,674 L684.5,674 A0,0 0 0 0 684.5,674 " fill="#FBFB77" filter="url(#f7o3uaixw28re)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M919.5,674 L919.5,684 L929.5,684 L919.5,674 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="690.5" y="692.6221">apply a global policy to all /data/ folders</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="690.5" y="709.7671">created via</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="33" x="755.5" y="709.7671">mkdir</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="119" x="415.5" y="1008"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="99" x="425.5" y="1030.5742">enablefileencrypto</text><polygon fill="#FEFECE" filter="url(#f7o3uaixw28re)" points="332,1153,344,1165,332,1177,320,1165,332,1153" style="stroke:#A80036;stroke-width:1.5;"/><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="81" x="382.5" y="1147"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="61" x="392.5" y="1169.5742">decrypt key</text><path d="M483.5,1151.5 L483.5,1161 L463.68,1165 L483.5,1169 L483.5,1178.645 A0,0 0 0 0 483.5,1178.645 L616.5,1178.645 A0,0 0 0 0 616.5,1178.645 L616.5,1161.5 L606.5,1151.5 L483.5,1151.5 A0,0 0 0 0 483.5,1151.5 " fill="#FBFB77" filter="url(#f7o3uaixw28re)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M606.5,1151.5 L606.5,1161.5 L616.5,1161.5 L606.5,1151.5 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="489.5" y="1170.1221">/data/uncrypted/ref</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="167" x="31.5" y="1294.5"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="147" x="41.5" y="1317.0742">e4crypt_initialize_global_de</text><path d="M219,1247.5 L219,1308.5 L198.53,1312.5 L219,1316.5 L219,1377.5151 A0,0 0 0 0 219,1377.5151 L407,1377.5151 A0,0 0 0 0 407,1377.5151 L407,1257.5 L397,1247.5 L219,1247.5 A0,0 0 0 0 219,1247.5 " fill="#FBFB77" filter="url(#f7o3uaixw28re)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M397,1247.5 L397,1257.5 L407,1257.5 L397,1247.5 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="225" y="1266.1221">/data/unencrypted/key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="276" y="1283.2671">version</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="276" y="1300.4121">secdiscardable</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="276" y="1317.5571">salt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="276" y="1334.7021">stretching</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="276" y="1351.8472">encrypted_key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="276" y="1368.9922">keymaster_key_blob</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="155" x="280.5" y="1427"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="135" x="290.5" y="1449.5742">add key to keyring Logon</text><path d="M121.5,1431.5 L121.5,1458.645 A0,0 0 0 0 121.5,1458.645 L260.5,1458.645 A0,0 0 0 0 260.5,1458.645 L260.5,1449.5 L280.16,1445 L260.5,1441.5 L260.5,1441.5 L250.5,1431.5 L121.5,1431.5 A0,0 0 0 0 121.5,1431.5 " fill="#FBFB77" filter="url(#f7o3uaixw28re)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M250.5,1431.5 L250.5,1441.5 L260.5,1441.5 L250.5,1431.5 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="127.5" y="1450.1221">/dev/unrandom 64bit</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="117" x="686.5" y="1008"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="97" x="696.5" y="1030.5742">e4crypt_init_user0</text><polygon fill="#FEFECE" filter="url(#f7o3uaixw28re)" points="778,1153,790,1165,778,1177,766,1165,778,1153" style="stroke:#A80036;stroke-width:1.5;"/><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="174" x="691" y="1294.5"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="154" x="701" y="1317.0742">create_and_install_user_keys</text><path d="M885.5,1239 L885.5,1308.5 L865.38,1312.5 L885.5,1316.5 L885.5,1386.1602 A0,0 0 0 0 885.5,1386.1602 L1136.5,1386.1602 A0,0 0 0 0 1136.5,1386.1602 L1136.5,1249 L1126.5,1239 L885.5,1239 A0,0 0 0 0 885.5,1239 " fill="#FBFB77" filter="url(#f7o3uaixw28re)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1126.5,1239 L1126.5,1249 L1136.5,1249 L1126.5,1239 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="891.5" y="1257.6221">/data/misc/vold/user_keys/de/0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="891.5" y="1274.7671">/data/misc/vold/user_keys/ce/0/current</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="984.5" y="1291.9121">version</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="984.5" y="1309.0571">secdiscardalbe</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="984.5" y="1326.2021">salt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="984.5" y="1343.3472">strectching</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="984.5" y="1360.4922">encrypted_key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="984.5" y="1377.6372">keymaster_key_blob</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="152" x="540" y="1427"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="132" x="550" y="1449.5742">install_key(dekey&amp;cekey)</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="154" x="32" y="1540.5"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="134" x="42" y="1563.0742">add_key to keyring logon</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="109" x="636.5" y="1147"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="89" x="646.5" y="1169.5742">load_all_de_keys</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="67.4785" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="156" x="515" y="1279"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="136" x="525" y="1301.5742">decrypt all dekey from dir</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="594.5" y="1317.4004"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="114" x="536" y="1333.2266">add all key to keyring</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="201" x="989.5" y="1008"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="181" x="999.5" y="1030.5742">encrypt_prepare_user_storage(de)</text><path d="M1211,961 L1211,1022 L1190.87,1026 L1211,1030 L1211,1091.0151 A0,0 0 0 0 1211,1091.0151 L1445,1091.0151 A0,0 0 0 0 1445,1091.0151 L1445,971 L1435,961 L1211,961 A0,0 0 0 0 1211,961 " fill="#FBFB77" filter="url(#f7o3uaixw28re)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1435,961 L1435,971 L1445,971 L1435,961 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="1217" y="979.6221">/data/system/users/0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="1217" y="996.7671">/data/misc/user/0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1217" y="1013.9121">/data/misc/profiles/cur/0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="1217" y="1031.0571">/data/misc/profiles/cur/0/forign-dex/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1217" y="1048.2021">/data/misc_de/0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="1217" y="1065.3472">/data/system_de/0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="1217" y="1082.4922">/data/user_de/0</text><polygon fill="#FEFECE" filter="url(#f7o3uaixw28re)" points="1183,1153,1195,1165,1183,1177,1171,1165,1183,1153" style="stroke:#A80036;stroke-width:1.5;"/><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="163" x="1156.5" y="1294.5"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="140" x="1169.5" y="1317.0742">e4crypt_policy_ensure(dir)</text><polygon fill="#FEFECE" filter="url(#f7o3uaixw28re)" points="1196,1433,1208,1445,1196,1457,1184,1445,1196,1433" style="stroke:#A80036;stroke-width:1.5;"/><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="385" x="1003.5" y="1540.5"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="365" x="1013.5" y="1563.0742">已经设置过加密, check当前的key_ref与node中保存的key_ref是否相同</text><path d="M1409,1545 L1409,1554.5 L1388.77,1558.5 L1409,1562.5 L1409,1572.145 A0,0 0 0 0 1409,1572.145 L1651,1572.145 A0,0 0 0 0 1651,1572.145 L1651,1555 L1641,1545 L1409,1545 A0,0 0 0 0 1409,1545 " fill="#FBFB77" filter="url(#f7o3uaixw28re)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1641,1545 L1641,1555 L1651,1555 L1641,1545 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="1415" y="1563.6221">EXT4_IOC_GET_ENCRYPTION_POLICY</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="67.4785" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="224" x="206" y="1525"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="40" x="298" y="1547.5742">ioctl(fd,</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="204" x="216" y="1563.4004">EXT4_IOC_SET_ENCRYPTION_POLICY,</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="126" x="255" y="1579.2266">ext4_encryption_policy)</text><path d="M450.5,1519 L450.5,1554.5 L430.22,1558.5 L450.5,1562.5 L450.5,1597.5801 A0,0 0 0 0 450.5,1597.5801 L983.5,1597.5801 A0,0 0 0 0 983.5,1597.5801 L983.5,1529 L973.5,1519 L450.5,1519 A0,0 0 0 0 450.5,1519 " fill="#FBFB77" filter="url(#f7o3uaixw28re)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M973.5,1519 L973.5,1529 L983.5,1529 L973.5,1519 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="456.5" y="1537.6221">fs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="456.5" y="1554.7671">inode set EXT4_INODE_ENCRYPT flag 访问文件夹时,会check EXT4_INODE_ENCRYPT flag</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="456.5" y="1571.9121">如果有, 说明已经加密,会进行request_key的操作,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="456.5" y="1589.0571">policy==key_ref</text><ellipse cx="836" cy="16" fill="#000000" filter="url(#f7o3uaixw28re)" rx="10" ry="10" style="stroke:none;stroke-width:1.0;"/><polygon fill="#FEFECE" filter="url(#f7o3uaixw28re)" points="758,67,770,79,758,91,746,79,758,67" style="stroke:#A80036;stroke-width:1.5;"/><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="159" x="427.5" y="147"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="139" x="437.5" y="169.5742">convert_to_file_encryption</text><rect fill="#FEFECE" filter="url(#f7o3uaixw28re)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="188" x="607" y="147"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="168" x="617" y="169.5742">--wipe-data-reason=convert_fbe</text><!--MD5=[9e7bccaab94f33706b7c2613f3cc0026]
link start to #3--><path d="M828.52,22.85 C814.58,33.75 784.59,57.21 768.58,69.73 " fill="none" id="start-to-#3" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="764.46,72.95,774.0181,70.5748,768.4045,69.8773,769.1019,64.2636,764.46,72.95" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="108" x="777.6856" y="67.6772">MF_FORCEFDEORFBE</text><!--MD5=[e7f1ddc5fb4d780e2cd8e7ad5cb89cb2]
link #3 to convert_to_file_encryption--><path d="M749.65,82.79 C721.01,92.38 625.08,124.48 562.77,145.34 " fill="none" id="#3-to-convert_to_file_encryption" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="557.97,146.94,567.7764,147.8533,562.7077,145.3417,565.2192,140.273,557.97,146.94" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="17" x="663" y="123.5264">yes</text><!--MD5=[b0f82d5f964d0364e74b383e5149d9e1]
link convert_to_file_encryption to - -wipe-data-reason=convert_fbe--><path d="M586.57,165 C591.6,165 596.63,165 601.66,165 " fill="none" id="convert_to_file_encryption-to---wipe-data-reason=convert_fbe" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="606.68,165,597.68,161,601.68,165,597.68,169,606.68,165" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[ec8646b6710aae8da3c1d6452ba9c585]
link - -wipe-data-reason=convert_fbe to format_volume(/data)--><path d="M688.62,183.1 C672.71,205.1 645.05,243.33 627.68,267.34 " fill="none" id="--wipe-data-reason=convert_fbe-to-format_volume(/data)" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="624.56,271.65,633.0709,266.6937,627.4864,267.5959,626.5842,262.0114,624.56,271.65" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="32" x="673" y="215.5264">reboot</text><!--MD5=[5ca4d20bcd04e69136406e91a27b5fc6]
link format_volume(/data) to /data/convert_fbe--><path d="M682.46,290 C694.96,290 707.91,290 720.21,290 " fill="none" id="format_volume(/data)-to-/data/convert_fbe" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="725.44,290,716.44,286,720.44,290,716.44,294,725.44,290" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="22" x="692.75" y="283.5264">生成</text><!--MD5=[e14fa21a0a99f2249039218da72f8a60]
link /data/convert_fbe to mount_all--><path d="M777.92,308.1 C769.28,332.41 753.43,376.99 743.89,403.82 " fill="none" id="/data/convert_fbe-to-mount_all" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="742.18,408.61,748.9575,401.464,743.8508,403.8974,741.4174,398.7907,742.18,408.61" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="32" x="766" y="352.5264">reboot</text><!--MD5=[de43b3550a1aab3110c52145395d5744]
link mount_all to #18--><path d="M734.02,445.06 C732.72,456.31 731.02,470.91 729.77,481.77 " fill="none" id="mount_all-to-#18" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="729.19,486.77,734.1916,478.2856,729.761,481.8027,726.2439,477.3721,729.19,486.77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="218" x="489.9649" y="480.7573">/data/convert_fbe &amp;&amp; MF_FORCEFDEORFBE</text><!--MD5=[9d07beee2c5e5715ae5ada8a87527ce1]
link #18 to <b>install_keyring\nro.crypto.state=encrypted\nro.encrypto.type=file--><path d="M727.67,510.03 C727.3,522.24 726.69,542.59 726.14,560.7 " fill="none" id="#18-to-&lt;b&gt;install_keyring\nro.crypto.state=encrypted\nro.encrypto.type=file" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="725.99,565.74,730.2454,556.8579,726.1328,560.742,722.2487,556.6294,725.99,565.74" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="17" x="728" y="542.5264">yes</text><!--MD5=[583d6ab6a42cea0c00a4d863814cf2b8]
link <b>install_keyring\nro.crypto.state=encrypted\nro.encrypto.type=file to installkey--><path d="M659.96,633.02 C631.51,647.25 599.1,663.45 574.56,675.72 " fill="none" id="&lt;b&gt;install_keyring\nro.crypto.state=encrypted\nro.encrypto.type=file-to-installkey" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="570.07,677.96,579.9081,677.5002,574.5393,675.7182,576.3213,670.3494,570.07,677.96" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[b25dc60ba38776db02109eddffebca47]
link installkey to #25--><path d="M538.84,714.3 C540.89,726.73 543.61,743.32 545.56,755.15 " fill="none" id="installkey-to-#25" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="546.39,760.22,548.8739,750.6895,545.5773,755.2865,540.9803,751.9899,546.39,760.22" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="99" x="429.1821" y="751.5026">ro.crypto.type is file</text><!--MD5=[0947c1d3cad7bc04c8be01e4c8d71390]
link #25 to vdc vold enablefileencrypto--><path d="M551.36,780.05 C556.49,792.37 566.46,816.3 573.84,834.02 " fill="none" id="#25-to-vdc vold enablefileencrypto" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="575.85,838.84,576.07,828.9936,573.9219,834.2267,568.6887,832.0786,575.85,838.84" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="17" x="567" y="815.5264">yes</text><!--MD5=[ca71ffcfd996400a337bdf04a4f59bfd]
link installkey to init_user0--><path d="M571.58,696 C576.65,696 581.72,696 586.79,696 " fill="none" id="installkey-to-init_user0" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="591.85,696,582.85,692,586.85,696,582.85,700,591.85,696" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[bd657365b15aba9681c5b3f1b7d9d1b9]
link start to mkdir--><path d="M845.56,19.54 C866.39,25.73 914,43.62 914,78 C914,78 914,78 914,291 C914,330.94 922.26,376.89 927.88,403.56 " fill="none" id="start-to-mkdir" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="928.97,408.63,931.0031,398.9933,927.9263,403.7402,923.1794,400.6633,928.97,408.63" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[eba52ba8aa014b9055186430bc44e7d9]
link mkdir to #34--><path d="M936.71,445.06 C939.24,456.72 942.56,471.99 944.94,482.95 " fill="none" id="mkdir-to-#34" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="946.03,487.95,948.0362,478.3076,944.9726,483.0631,940.2171,479.9995,946.03,487.95" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="124" x="800.6166" y="463.5737">in directories_to_exclude</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="87" x="822.1166" y="478.0811">/data/的下级目录</text><!--MD5=[74296565a2ec9280092c42289502d8bc]
link #34 to decrypt key from \n /data/uncrypt/ref--><path d="M948.83,509.27 C949.94,523.1 951.96,548.27 953.58,568.36 " fill="none" id="#34-to-decrypt key from \n /data/uncrypt/ref" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="953.98,573.35,957.2474,564.0589,953.5801,568.366,949.2731,564.6987,953.98,573.35" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="12" x="952" y="542.5264">no</text><!--MD5=[4c859d017636b74b42ea1fcafa161d52]
link decrypt key from \n /data/uncrypt/ref to e4crypt_policy_ensure(dir)--><path d="M975.83,625.82 C987.55,640.79 1002.22,659.52 1013.33,673.72 " fill="none" id="decrypt key from \n /data/uncrypt/ref-to-e4crypt_policy_ensure(dir)" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1016.66,677.97,1014.2632,668.4172,1013.5785,674.0325,1007.9632,673.3477,1016.66,677.97" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[630643f6ff6382badf7d6989ff47bd1a]
link vdc vold enablefileencrypto to enablefileencrypto--><path d="M571.85,875.24 C552.04,905.87 510.77,969.68 489.06,1003.27 " fill="none" id="vdc vold enablefileencrypto-to-enablefileencrypto" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="486.25,1007.6,494.4945,1002.2122,488.9639,1003.4006,487.7755,997.87,486.25,1007.6" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[955ef6c711b3bce1faf34e1ce8fa3b9f]
link enablefileencrypto to #47--><path d="M457.18,1044.07 C426.6,1073.37 365.17,1132.23 341.55,1154.85 " fill="none" id="enablefileencrypto-to-#47" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="337.84,1158.4,347.1018,1155.0505,341.4461,1154.9365,341.5601,1149.2807,337.84,1158.4" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="130" x="181.9575" y="1150.0873">/data/uncrypted/key exist</text><!--MD5=[1c8c9e06ea68d62c29909731e4bc90f8]
link #47 to decrypt key--><path d="M344.27,1165 C352.85,1165 364.88,1165 376.97,1165 " fill="none" id="#47-to-decrypt key" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="382.14,1165,373.14,1161,377.14,1165,373.14,1169,382.14,1165" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="17" x="354.75" y="1158.5264">yes</text><!--MD5=[53b3635624781fb08df7b7909dcded9a]
link #47 to e4crypt_initialize_global_de--><path d="M324.6,1169.98 C305.18,1180.51 251.33,1210.27 209,1239 C184.74,1255.46 158.42,1276.01 139.82,1291.03 " fill="none" id="#47-to-e4crypt_initialize_global_de" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="135.73,1294.33,145.2431,1291.7802,139.6176,1291.1857,140.2121,1285.5601,135.73,1294.33" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="12" x="266" y="1215.5264">no</text><!--MD5=[46bc8b6b1de3f716b7183b4929a06787]
link e4crypt_initialize_global_de to add key to keyring Logon--><path d="M133.66,1330.5 C151.85,1346.43 180.83,1370.09 209,1386 C237.1,1401.87 270.42,1415.29 298.41,1425.21 " fill="none" id="e4crypt_initialize_global_de-to-add key to keyring Logon" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="303.21,1426.9,296.0458,1420.1417,298.4929,1425.2419,293.3928,1427.689,303.21,1426.9" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[0c35d7912d60e956d0b361e3e3728629]
link decrypt key to add key to keyring Logon--><path d="M426.7,1183.21 C434.07,1221.54 447.43,1316.11 417,1386 C410.56,1400.79 398.42,1413.77 386.81,1423.67 " fill="none" id="decrypt key-to-add key to keyring Logon" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="382.91,1426.91,392.3964,1424.2628,386.7651,1423.726,387.302,1418.0946,382.91,1426.91" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="46" x="437" y="1317.0264">2-Sha512</text><!--MD5=[6b67458c22d86f4cd64c65cb2e35ebb8]
link init_user0 to e4crypt_init_user0--><path d="M634.13,714.17 C653.79,769.3 715.31,941.78 737.19,1003.09 " fill="none" id="init_user0-to-e4crypt_init_user0" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="738.93,1008,739.6567,998.178,737.242,1003.2936,732.1264,1000.8788,738.93,1008" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[b7f5bf0b3ee1de488321e8344536b94e]
link e4crypt_init_user0 to #68--><path d="M749.11,1044.07 C755.73,1071.53 768.6,1124.96 774.67,1150.18 " fill="none" id="e4crypt_init_user0-to-#68" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="775.86,1155.12,777.6384,1145.433,774.6877,1150.2594,769.8614,1147.3087,775.86,1155.12" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="192" x="797.5651" y="1148.8015">/data/misc/vold/user_keys/de/0 exist</text><!--MD5=[b41f42cdc14eae41f12565c3dba26c38]
link #68 to create_and_install_user_keys--><path d="M778,1177.42 C778,1201.48 778,1257.78 778,1289.24 " fill="none" id="#68-to-create_and_install_user_keys" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="778,1294.44,782,1285.44,778,1289.44,774,1285.44,778,1294.44" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="21" x="779" y="1215.5264">no 1</text><!--MD5=[dd49984854cc5c350dc747f18b6c8740]
link create_and_install_user_keys to install_key(dekey&cekey)--><path d="M756.82,1330.56 C727.11,1354.5 673.13,1397.98 641.33,1423.6 " fill="none" id="create_and_install_user_keys-to-install_key(dekey&amp;cekey)" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="637.18,1426.94,646.6931,1424.3902,641.0676,1423.7957,641.6621,1418.1701,637.18,1426.94" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[079bebcdb7a22a51e760136261a4237f]
link install_key(dekey&cekey) to add_key to keyring logon--><path d="M539.98,1453.55 C454.84,1463.3 313.4,1483.41 196,1519 C179.53,1523.99 162.05,1531.3 147.11,1538.21 " fill="none" id="install_key(dekey&amp;cekey)-to-add_key to keyring logon" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="142.56,1540.34,152.4072,1540.1571,147.0906,1538.2248,149.0228,1532.9082,142.56,1540.34" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[630d0d392b78f3ef1f6a39fbfa222ff1]
link e4crypt_init_user0 to load_all_de_keys--><path d="M738.27,1044.07 C728.53,1068.79 710.49,1114.55 699.73,1141.84 " fill="none" id="e4crypt_init_user0-to-load_all_de_keys" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="697.81,1146.71,704.8226,1139.7945,699.6374,1142.0559,697.376,1136.8707,697.81,1146.71" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="6" x="712" y="1123.5264">2</text><!--MD5=[d8249a2a0951a070e285dcd045f450ac]
link load_all_de_keys to decrypt all dekey from dir\n\nadd all key to keyring--><path d="M679.37,1183.26 C664.3,1205.65 637.6,1245.29 617.86,1274.59 " fill="none" id="load_all_de_keys-to-decrypt all dekey from dir\n\nadd all key to keyring" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="615,1278.84,623.3454,1273.6099,617.7932,1274.693,616.7101,1269.1407,615,1278.84" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[12185c5735c2af2848a813942022a8fd]
link e4crypt_init_user0 to encrypt_prepare_user_storage(de)--><path d="M803.52,1026 C852.79,1026 924.51,1026 983.86,1026 " fill="none" id="e4crypt_init_user0-to-encrypt_prepare_user_storage(de)" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="989.2,1026,980.2,1022,984.2,1026,980.2,1030,989.2,1026" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="6" x="893.5" y="1019.5264">3</text><!--MD5=[ad9829845118e4ed74f9cf20ed74b9da]
link encrypt_prepare_user_storage(de) to #89--><path d="M1101.59,1044.07 C1120.95,1072.59 1159.32,1129.11 1175.51,1152.97 " fill="none" id="encrypt_prepare_user_storage(de)-to-#89" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1178.44,1157.28,1176.6989,1147.5863,1175.6335,1153.1419,1170.0779,1152.0766,1178.44,1157.28" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="179" x="983.8613" y="1152.4104">查询之前保存到内存中的key_ref信息</text><!--MD5=[79510e83db1631be0bb1f2685ded9f54]
link #89 to  e4crypt_policy_ensure(dir)--><path d="M1186.11,1174.24 C1194.4,1196.15 1217.18,1256.43 1229.62,1289.34 " fill="none" id="#89-to- e4crypt_policy_ensure(dir)" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1231.53,1294.38,1232.1152,1284.5485,1229.7744,1289.6984,1224.6246,1287.3575,1231.53,1294.38" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[f23fcd3aec54aed13a5e418aecc007f2]
link  e4crypt_policy_ensure(dir) to #94--><path d="M1232.51,1330.56 C1224.03,1356.9 1207.94,1406.89 1200.27,1430.72 " fill="none" id=" e4crypt_policy_ensure(dir)-to-#94" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1198.68,1435.66,1205.2614,1428.333,1200.2225,1430.9039,1197.6517,1425.865,1198.68,1435.66" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="59" x="1215.9768" y="1424.54">dir is empty</text><!--MD5=[3bb0873b1245c8b77b376ce36a99f119]
link #94 to 已经设置过加密, check当前的key_ref与node中保存的key_ref是否相同--><path d="M1196,1457.1 C1196,1475.23 1196,1511.53 1196,1535.16 " fill="none" id="#94-to-已经设置过加密, check当前的key_ref与node中保存的key_ref是否相同" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1196,1540.29,1200,1531.29,1196,1535.29,1192,1531.29,1196,1540.29" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="50" x="1197" y="1495.5264">not empty</text><!--MD5=[3e0ff70ef845103be5b1d6c5cfbe172a]
link #94 to ioctl(fd,\nEXT4_IOC_SET_ENCRYPTION_POLICY,\next4_encryption_policy)--><path d="M1184.79,1446.21 C1115.59,1447.72 739.79,1458.47 441,1519 C434.36,1520.35 427.57,1521.91 420.76,1523.63 " fill="none" id="#94-to-ioctl(fd,\nEXT4_IOC_SET_ENCRYPTION_POLICY,\next4_encryption_policy)" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="415.54,1524.97,425.2518,1526.6072,420.3831,1523.7271,423.2632,1518.8583,415.54,1524.97" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="59" x="668" y="1495.5264">dir is empty</text><!--MD5=[e30af3bd27377e8c6475cb832fbd2dc8]
@startuml
(*) - -> if "MF_FORCEFDEORFBE" then
- -> [yes]convert_to_file_encryption
-r-> "- -wipe-data-reason=convert_fbe"
partition recovery {
-d->[reboot]format_volume(/data)
-r->[生成] "/data/convert_fbe"
}
partition init {
-d->[reboot]mount_all
if "/data/convert_fbe && MF_FORCEFDEORFBE" then
- ->[yes] "<b>install_keyring\nro.crypto.state=encrypted\nro.encrypto.type=file"
- ->installkey
if "ro.crypto.type is file" then 
- -> [yes ] "vdc vold enablefileencrypto"
installkey -r-> init_user0
(*)-d->mkdir
if "in directories_to_exclude \n /data/的下级目录"  then
- ->[no] "decrypt key from \n /data/uncrypt/ref"
- -> e4crypt_policy_ensure(dir)
note left
apply a global policy to all /data/ folders
created via <b>mkdir
endnote
}

partition vold {
"vdc vold enablefileencrypto" -d-> "enablefileencrypto"
if "/data/uncrypted/key exist" then
-r-> [yes] "decrypt key"
note right
/data/uncrypted/ref
endnote
else 
-d-> [no] "e4crypt_initialize_global_de"
note right
/data/unencrypted/key
                 version
                 secdiscardable
                 salt
                 stretching
                 encrypted_key
                 keymaster_key_blob
endnote
endif
- ->"add key to keyring Logon"
note left
/dev/unrandom 64bit
endnote
"decrypt key"- ->[2-Sha512]"add key to keyring Logon"
"init_user0" -d-> "e4crypt_init_user0"
if "/data/misc/vold/user_keys/de/0 exist" then 
- ->[no 1] create_and_install_user_keys
endif
note right
/data/misc/vold/user_keys/de/0
/data/misc/vold/user_keys/ce/0/current
                               version
                               secdiscardalbe
                               salt
                               strectching
                               encrypted_key
                               keymaster_key_blob
endnote
- -> "install_key(dekey&cekey)"
- -> "add_key to keyring logon"
e4crypt_init_user0 - ->[2] load_all_de_keys
- -> "decrypt all dekey from dir\n
add all key to keyring"
e4crypt_init_user0 -r->[3] encrypt_prepare_user_storage(de)
note right
/data/system/users/0
/data/misc/user/0
/data/misc/profiles/cur/0
/data/misc/profiles/cur/0/forign-dex/
/data/misc_de/0
/data/system_de/0
/data/user_de/0
endnote
if "查询之前保存到内存中的key_ref信息" then 
- -> " e4crypt_policy_ensure(dir)"
if "dir is empty" then
- ->[not empty] "已经设置过加密, check当前的key_ref与node中保存的key_ref是否相同"
note right
EXT4_IOC_GET_ENCRYPTION_POLICY
endnote
else
- ->[dir is empty] "ioctl(fd,\nEXT4_IOC_SET_ENCRYPTION_POLICY,\next4_encryption_policy)"
note right
fs
inode set EXT4_INODE_ENCRYPT flag 访问文件夹时,会check EXT4_INODE_ENCRYPT flag
如果有, 说明已经加密,会进行request_key的操作,
policy==key_ref
endnote
endif
}
@enduml

PlantUML version 1.2020.22(Sun Dec 06 17:36:27 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>