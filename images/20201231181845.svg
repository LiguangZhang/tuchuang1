<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1303px" preserveAspectRatio="none" style="width:876px;height:1303px;" version="1.1" viewBox="0 0 876 1303" width="876px" zoomAndPan="magnify"><defs><filter height="300%" id="f1j36l25bqvegx" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[b640757cfa541fdcaf447e810587d780]
cluster AMS--><polygon fill="#FFFFFF" filter="url(#f1j36l25bqvegx)" points="565,6.2939,601,6.2939,608,30.7578,751,30.7578,751,233.2939,565,233.2939,565,6.2939" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="565" x2="608" y1="30.7578" y2="30.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="30" x="569" y="22.9639">AMS</text><!--MD5=[f50b12677e4a99cf57eeeced6a31c371]
cluster UserController--><polygon fill="#FFFFFF" filter="url(#f1j36l25bqvegx)" points="558,266.2939,657,266.2939,664,290.7578,758,290.7578,758,663.2939,558,663.2939,558,266.2939" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="558" x2="664" y1="290.7578" y2="290.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="562" y="282.9639">UserController</text><!--MD5=[c5fce3abb9d6475e197b946813ca3178]
cluster vold--><polygon fill="#FFFFFF" filter="url(#f1j36l25bqvegx)" points="100,696.2939,133,696.2939,140,720.7578,727,720.7578,727,1296.2939,100,1296.2939,100,696.2939" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="100" x2="140" y1="720.7578" y2="720.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="104" y="712.9639">vold</text><ellipse cx="658" cy="53.2939" fill="#000000" filter="url(#f1j36l25bqvegx)" rx="10" ry="10" style="stroke:none;stroke-width:1.0;"/><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="154" x="581" y="104.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="134" x="591" y="126.8682">bootAnimationComplete</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="92" x="612" y="181.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="72" x="622" y="203.8682">finishBooting</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="168" x="574" y="303.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="148" x="584" y="325.8682">sendBootCompletedLocked</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="99" x="608.5" y="380.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="79" x="618.5" y="402.8682">finishUserBoot</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="118" x="599" y="457.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="98" x="609" y="479.8682">maybeUnlockUser</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="121" x="597.5" y="534.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="101" x="607.5" y="556.8682">unlockUserCleared</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="100" x="608" y="611.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="80" x="618" y="633.8682">unlockUserKey</text><polygon fill="#FEFECE" filter="url(#f1j36l25bqvegx)" points="658,739.2939,670,751.2939,658,763.2939,646,751.2939,658,739.2939" style="stroke:#A80036;stroke-width:1.5;"/><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="107" x="604.5" y="863.7939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="87" x="614.5" y="886.3682">unlock_user_key</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="149" x="562.5" y="979.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="129" x="572.5" y="1001.8682">parse_hex(token, secret)</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="79" x="319.5" y="1111.7939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="59" x="329.5" y="1134.3682">retrieveKey</text><path d="M419,1056.2939 L419,1125.7939 L398.58,1129.7939 L419,1133.7939 L419,1203.4541 A0,0 0 0 0 419,1203.4541 L685,1203.4541 A0,0 0 0 0 685,1203.4541 L685,1066.2939 L675,1056.2939 L419,1056.2939 A0,0 0 0 0 419,1056.2939 " fill="#FBFB77" filter="url(#f1j36l25bqvegx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M675,1056.2939 L675,1066.2939 L685,1066.2939 L675,1056.2939 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="425" y="1074.916">decrypt ce key from:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="428" y="1092.061">/data/misc/vold/user_keys/ce/0/current</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="554" y="1109.2061">version</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="88" x="554" y="1126.3511">secdiscardable</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="554" y="1143.4961">salt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="428" y="1160.6411"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58" x="551" y="1160.6411">stretching</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="551" y="1177.7861">encrypted_key</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="119" x="551" y="1194.9312">keymaster_key_blob</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="133" x="166.5" y="1244.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="113" x="176.5" y="1266.8682">add ce key to keyring</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="204" x="379" y="733.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="184" x="389" y="755.8682">send prepare_user_storage to vold</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="172" x="412" y="863.7939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="152" x="422" y="886.3682">e4crypt_unlock_user_key(ce)</text><path d="M116,825.2939 L116,938.1641 A0,0 0 0 0 116,938.1641 L392,938.1641 A0,0 0 0 0 392,938.1641 L392,885.7939 L411.63,881.7939 L392,877.7939 L392,835.2939 L382,825.2939 L116,825.2939 A0,0 0 0 0 116,825.2939 " fill="#FBFB77" filter="url(#f1j36l25bqvegx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M382,825.2939 L382,835.2939 L392,835.2939 L382,825.2939 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="122" y="843.916">lookup ce_key_refs from s_ce_key_raw_refs:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="125" y="861.061">/data/system_ce/0</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="125" y="878.2061">/data/misc_ce/0</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="125" y="895.3511">/data/media/0</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="60" x="125" y="912.4961">/data/data</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="116" x="125" y="929.6411">/data/user/&lt;userid&gt;</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="115" x="427.5" y="979.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="95" x="437.5" y="1001.8682">ensure_policy(dir)</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="204" x="7" y="181.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="184" x="17" y="203.8682">add user to mLocalUnlockedUsers</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="128" x="116" y="303.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="108" x="126" y="325.8682">finishUserUnlocking</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="129" x="264.5" y="380.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="109" x="274.5" y="402.8682">onBeforeUnlockUser</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="111" x="356.5" y="457.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="91" x="366.5" y="479.8682">prepareUserData</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="120" x="394" y="534.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="100" x="404" y="556.8682">prepareUserDataLI</text><rect fill="#FEFECE" filter="url(#f1j36l25bqvegx)" height="35.8262" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="127" x="395.5" y="611.2939"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="107" x="405.5" y="633.8682">prepareUserStorage</text><!--MD5=[0a7e6a09b311123aa79cf45fcfbb564a]
link start to bootAnimationComplete--><path d="M658,63.3339 C658,72.4539 658,86.9039 658,99.0939 " fill="none" id="start-to-bootAnimationComplete" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="658,104.1639,662,95.1639,658,99.1639,654,95.1639,658,104.1639" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[107b762645b4701b0d6088eca1ca7b0e]
link bootAnimationComplete to finishBooting--><path d="M658,140.3139 C658,150.8839 658,164.5839 658,176.0139 " fill="none" id="bootAnimationComplete-to-finishBooting" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="658,181.0839,662,172.0839,658,176.0839,654,172.0839,658,181.0839" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[de8d0d71d971eb32feb16b42e9e2acbe]
link finishBooting to sendBootCompletedLocked--><path d="M658,217.4839 C658,238.6939 658,274.7939 658,298.0839 " fill="none" id="finishBooting-to-sendBootCompletedLocked" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="658,303.1339,662,294.1339,658,298.1339,654,294.1339,658,303.1339" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[8c32f779750348ca2762046f2638ad8d]
link sendBootCompletedLocked to finishUserBoot--><path d="M658,339.3139 C658,349.8839 658,363.5839 658,375.0139 " fill="none" id="sendBootCompletedLocked-to-finishUserBoot" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="658,380.0839,662,371.0839,658,375.0839,654,371.0839,658,380.0839" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[997a4d0b2512fdf67291f8b98dc78e5a]
link finishUserBoot to maybeUnlockUser--><path d="M658,416.3139 C658,426.8839 658,440.5839 658,452.0139 " fill="none" id="finishUserBoot-to-maybeUnlockUser" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="658,457.0839,662,448.0839,658,452.0839,654,448.0839,658,457.0839" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[ed8be2474797739bd8cc946e2d0735dc]
link maybeUnlockUser to unlockUserCleared--><path d="M658,493.3139 C658,503.8839 658,517.5839 658,529.0139 " fill="none" id="maybeUnlockUser-to-unlockUserCleared" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="658,534.0839,662,525.0839,658,529.0839,654,525.0839,658,534.0839" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[bba16c145b32ce5d3796ccb7cb9478e1]
link unlockUserCleared to unlockUserKey--><path d="M658,570.3139 C658,580.8839 658,594.5839 658,606.0139 " fill="none" id="unlockUserCleared-to-unlockUserKey" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="658,611.0839,662,602.0839,658,606.0839,654,602.0839,658,611.0839" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[73702edd7b330b7f68f716d8912d897e]
link unlockUserKey to #20--><path d="M658,647.4839 C658,670.6439 658,711.5539 658,734.1639 " fill="none" id="unlockUserKey-to-#20" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="658,739.2239,662,730.2239,658,734.2239,654,730.2239,658,739.2239" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="722.8" y="716.2718">"ro.crypto.file is file</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="14" x="680.8" y="730.7791">&amp;&amp;</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="697.8" y="730.7791">user not in mLocalUnlockedUsers"</text><!--MD5=[2b99b3b636ce8d2d7990f18a6a218a93]
link #20 to unlock_user_key--><path d="M658,763.6939 C658,784.8839 658,830.6839 658,858.3139 " fill="none" id="#20-to-unlock_user_key" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="658,863.5839,662,854.5839,658,858.5839,654,854.5839,658,863.5839" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="17" x="659" y="801.8203">yes</text><!--MD5=[c5fd269175e99dbe8b7c304187750156]
link unlock_user_key to parse_hex(token, secret)--><path d="M654.81,900.0339 C651.14,919.8939 645.09,952.5839 641.07,974.2739 " fill="none" id="unlock_user_key-to-parse_hex(token, secret)" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="640.15,979.2639,645.7059,971.1318,641.0507,974.3457,637.8367,969.6906,640.15,979.2639" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[8e323d6bb837ba5a20727b89a79935c2]
link parse_hex(token, secret) to retrieveKey--><path d="M562.2,1014.5739 C500.76,1028.3939 421.82,1047.3639 409,1056.2939 C390.8,1068.9639 377.18,1090.5339 368.79,1106.8639 " fill="none" id="parse_hex(token, secret)-to-retrieveKey" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="366.35,1111.7539,373.9446,1105.4832,368.5803,1107.279,366.7846,1101.9147,366.35,1111.7539" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[9e38ed17f0399e89a780d6b59ab96390]
link retrieveKey to add ce key to keyring--><path d="M342.53,1147.8539 C319.51,1171.6939 277.78,1214.9139 253,1240.5739 " fill="none" id="retrieveKey-to-add ce key to keyring" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="249.48,1244.2339,258.6066,1240.5319,252.9507,1240.6347,252.8478,1234.9788,249.48,1244.2339" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[e1b07b35213856cbb6158c7ab6738868]
link send prepare_user_storage to vold to e4crypt_unlock_user_key(ce)--><path d="M483.26,769.3539 C486.29,792.3039 491.7,833.1439 495.05,858.4939 " fill="none" id="send prepare_user_storage to vold-to-e4crypt_unlock_user_key(ce)" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="495.73,863.6639,498.5126,854.2163,495.0729,858.7073,490.582,855.2677,495.73,863.6639" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[7f0f7038e07f0467e99f867a9af57ac7]
link e4crypt_unlock_user_key(ce) to ensure_policy(dir)--><path d="M496.03,900.0339 C493.75,919.8939 490.01,952.5839 487.52,974.2739 " fill="none" id="e4crypt_unlock_user_key(ce)-to-ensure_policy(dir)" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="486.95,979.2639,491.9516,970.7796,487.521,974.2967,484.0039,969.8661,486.95,979.2639" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[934173d28c4431b92dc1ade6fca84fb7]
reverse link add user to mLocalUnlockedUsers to add ce key to keyring--><path d="M101.85,222.4239 C94.78,246.3039 85,285.5839 85,320.2939 C85,320.2939 85,320.2939 85,1130.7939 C85,1186.6339 145,1224.2739 188.6,1244.2439 " fill="none" id="add user to mLocalUnlockedUsers-backto-add ce key to keyring" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="103.31,217.5639,96.8823,225.0262,101.8667,222.3511,104.5418,227.3355,103.31,217.5639" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="42" x="86" y="633.8203">success</text><!--MD5=[6e2207f39e08b0053f8e207027a2b64c]
link add user to mLocalUnlockedUsers to finishUserUnlocking--><path d="M119.17,217.4839 C131.83,238.8739 153.44,275.4039 167.2,298.6639 " fill="none" id="add user to mLocalUnlockedUsers-to-finishUserUnlocking" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="169.85,303.1339,168.7021,293.3522,167.3006,298.8327,161.8201,297.4313,169.85,303.1339" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[0d603dc9f8fcbd8442b0513cad13c3a5]
link finishUserUnlocking to onBeforeUnlockUser--><path d="M213.81,339.3139 C236.59,350.7839 266.69,365.9339 290.41,377.8739 " fill="none" id="finishUserUnlocking-to-onBeforeUnlockUser" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="295.07,380.2139,288.848,372.5794,290.6094,377.955,285.2337,379.7164,295.07,380.2139" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[0b0ac188e7a500805623c8682c237031]
link onBeforeUnlockUser to prepareUserData--><path d="M347.83,416.3139 C360.06,427.3539 376.06,441.8239 389.03,453.5439 " fill="none" id="onBeforeUnlockUser-to-prepareUserData" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="392.95,457.0839,388.9553,448.0816,389.2406,453.7312,383.591,454.0166,392.95,457.0839" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[b9a280a30e9988d27e7d83f6fdc21b25]
link prepareUserData to prepareUserDataLI--><path d="M421.53,493.3139 C427.56,504.0739 435.4,518.0739 441.87,529.6239 " fill="none" id="prepareUserData-to-prepareUserDataLI" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="444.36,534.0839,443.4614,524.2762,441.9209,529.7192,436.4778,528.1787,444.36,534.0839" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[a76a927e70de80db20b1f4c676d169f1]
link prepareUserDataLI to prepareUserStorage--><path d="M455.13,570.3139 C455.84,580.8839 456.75,594.5839 457.51,606.0139 " fill="none" id="prepareUserDataLI-to-prepareUserStorage" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="457.85,611.0839,461.2249,601.8314,457.5079,606.0957,453.2437,602.3787,457.85,611.0839" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[7c7cf0cbc416976a67f90583e2cee8ac]
link prepareUserStorage to send prepare_user_storage to vold--><path d="M462.15,647.4839 C466.04,668.6939 472.66,704.7939 476.93,728.0839 " fill="none" id="prepareUserStorage-to-send prepare_user_storage to vold" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="477.85,733.1339,480.1633,723.5606,476.9493,728.2157,472.2941,725.0018,477.85,733.1339" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[96e903dbcda0385b5a90bc810a62835b]
@startuml
partition AMS {
(*) -d-> "bootAnimationComplete"
-d-> "finishBooting"
}
partition UserController {
"finishBooting" -d-> "sendBootCompletedLocked"
-d->"finishUserBoot"
-d->"maybeUnlockUser"
-d->"unlockUserCleared"
-d->"unlockUserKey"
}
partition vold {
if <b>"ro.crypto.file is file \n && <b>user not in mLocalUnlockedUsers" then
-d->[yes] "unlock_user_key"
-d->"parse_hex(token, secret)"
-d->"retrieveKey"
note right
decrypt ce key from:
<b> /data/misc/vold/user_keys/ce/0/current
<b>                                           version
<b>                                           secdiscardable
<b>                                           salt
 <b>                                         stretching
<b>                                          encrypted_key
<b>                                          keymaster_key_blob
endnote
-d->"add ce key to keyring"
"send prepare_user_storage to vold" - -> e4crypt_unlock_user_key(ce)
note left
lookup ce_key_refs from s_ce_key_raw_refs:
<b> /data/system_ce/0
<b> /data/misc_ce/0
<b> /data/media/0
<b> /data/data
<b> /data/user/<userid>
endnote
- ->ensure_policy(dir)


}
"add ce key to keyring" -u->[success]"add user to mLocalUnlockedUsers"
-d->"finishUserUnlocking"
-d->onBeforeUnlockUser
-d->prepareUserData
- ->prepareUserDataLI
- ->prepareUserStorage
- ->"send prepare_user_storage to vold"
@enduml

PlantUML version 1.2020.22(Sun Dec 06 17:36:27 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>